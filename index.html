<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#1a1621">
  <title>TBC Logdiff</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256' viewBox='0 0 256 256'><rect width='256' height='256' fill='%231a1621'/><text x='128' y='155' text-anchor='middle' font-family='JetBrains%20Mono,monospace' font-size='96' font-weight='600' fill='%23b3f4f3'>WC</text></svg>">
  <style>
    :root {
      --bg-0: #14111b;
      --bg-1: #1a1621;
      --bg-2: #231f32;
      --bg-3: #2a2540;
      --ink: #eee9fc;
      --muted: #9a90b3;
      --line: #3f3951;
      --accent: #b3f4f3;
      --accent-2: #e192ef;
      --accent-3: #b1f2a7;
      --warn: #f0c27b;
      --danger: #e965a5;
      --shadow: rgba(0, 0, 0, 0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "JetBrains Mono", "SF Mono", Consolas, monospace;
      color: var(--ink);
      background: radial-gradient(1000px 600px at 10% -20%, #2b2436, transparent),
        radial-gradient(700px 500px at 90% -10%, #1c2a35, transparent),
        linear-gradient(160deg, var(--bg-0), var(--bg-1) 40%, var(--bg-0));
      min-height: 100vh;
      padding: 24px;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(transparent 95%, rgba(255, 255, 255, 0.03)),
        linear-gradient(90deg, transparent 95%, rgba(255, 255, 255, 0.02));
      background-size: 40px 40px;
      pointer-events: none;
      opacity: 0.4;
      mix-blend-mode: screen;
    }
    .shell {
      max-width: 1080px;
      margin: 0 auto;
      position: relative;
      z-index: 1;
    }
    .hero {
      display: flex;
      gap: 24px;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 24px;
    }
    .hero-title {
      font-family: "Space Grotesk", "JetBrains Mono", sans-serif;
      font-size: 36px;
      letter-spacing: -0.02em;
      margin: 0 0 6px 0;
      color: var(--accent);
    }
    .hero-sub {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
      text-transform: lowercase;
    }
    .hero-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--accent-3);
      font-size: 11px;
      text-transform: lowercase;
      background: rgba(34, 31, 50, 0.6);
      box-shadow: 0 6px 18px var(--shadow);
    }
    .hero-tag .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      box-shadow: 0 0 12px currentColor;
    }
    .panel {
      background: var(--bg-2);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 18px;
      margin-bottom: 18px;
      box-shadow: 0 10px 30px var(--shadow);
      animation: rise 0.6s ease both;
    }
    .panel-head {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
      gap: 12px;
    }
    .panel h2 {
      margin: 0;
      font-size: 13px;
      text-transform: lowercase;
      color: var(--accent);
      letter-spacing: 0.05em;
    }
    .panel-note {
      color: var(--muted);
      font-size: 11px;
    }
    .field-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }
    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .field span {
      color: var(--muted);
      font-size: 11px;
      text-transform: lowercase;
    }
    input, select, textarea {
      background: var(--bg-1);
      border: 1px solid var(--line);
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 8px;
      font-family: inherit;
      font-size: 12px;
    }
    input::placeholder, textarea::placeholder { color: var(--muted); }
    textarea {
      min-height: 72px;
      resize: vertical;
    }
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    .btn {
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-family: inherit;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      text-transform: lowercase;
    }
    .btn.primary {
      background: var(--accent);
      color: #1a1621;
      border-color: transparent;
      box-shadow: 0 10px 20px rgba(179, 244, 243, 0.2);
    }
    .btn:active {
      transform: translateY(1px);
    }
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
    }
    .stat {
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: rgba(26, 22, 33, 0.7);
    }
    .stat-label {
      color: var(--muted);
      font-size: 10px;
      text-transform: lowercase;
      margin-bottom: 6px;
    }
    .stat-value {
      font-size: 18px;
      color: var(--accent-3);
      font-weight: 600;
    }
    .stat-sub {
      font-size: 10px;
      color: var(--muted);
      margin-top: 6px;
    }
    .compare-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    .list {
      margin: 0;
      padding: 0;
      list-style: none;
      display: grid;
      gap: 10px;
    }
    .list li {
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
      background: rgba(26, 22, 33, 0.6);
    }
    .list-title {
      font-size: 11px;
      color: var(--accent-2);
      margin-bottom: 6px;
      text-transform: lowercase;
    }
    .list-body {
      font-size: 12px;
      color: var(--ink);
    }
    .ability-table {
      display: grid;
      gap: 8px;
    }
    .ability-row {
      display: grid;
      grid-template-columns: 1.2fr 0.7fr 0.7fr 0.7fr;
      gap: 8px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--line);
      background: rgba(20, 17, 27, 0.6);
      font-size: 11px;
    }
    .ability-row span {
      color: var(--muted);
    }
    .ability-row strong {
      color: var(--ink);
      font-weight: 600;
    }
    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
    }
    .footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      color: var(--muted);
      font-size: 11px;
    }
    .footer a {
      color: var(--muted);
      text-decoration: none;
    }
    .footer a:hover { color: var(--accent); }
    .badge {
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid var(--line);
      font-size: 10px;
      color: var(--muted);
      text-transform: lowercase;
    }
    .status-warn { color: var(--warn); }
    .status-ok { color: var(--accent-3); }
    .status-bad { color: var(--danger); }
    @keyframes rise {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @media (max-width: 960px) {
      .field-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .stat-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .compare-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      body { padding: 16px; }
      .hero { flex-direction: column; align-items: flex-start; }
      .field-grid { grid-template-columns: 1fr; }
      .stat-grid { grid-template-columns: 1fr; }
      .ability-row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <main class="shell">
    <header class="hero">
      <div>
        <h1 class="hero-title">tbc logdiff</h1>
        <p class="hero-sub">compare your warcraft logs to top tbc parses and get clear gaps</p>
      </div>
      <div class="hero-tag" id="api-tag"><span class="dot"></span><span id="api-status">demo mode</span></div>
    </header>

    <section class="panel" style="animation-delay: 0.05s;">
      <div class="panel-head">
        <h2>inputs</h2>
        <div class="panel-note">paste a report, or enter realm and character. compare player can be name-realm or use a compare report url.</div>
      </div>
      <form id="compare-form" autocomplete="off">
        <div class="field-grid">
          <label class="field">
            <span>region</span>
            <select id="region">
              <option value="us">us</option>
              <option value="eu">eu</option>
              <option value="kr">kr</option>
              <option value="tw">tw</option>
            </select>
          </label>
          <label class="field">
            <span>realm</span>
            <input id="realm" placeholder="example: gehennas">
          </label>
          <label class="field">
            <span>character</span>
            <input id="character" placeholder="example: dnyo">
          </label>
          <label class="field">
            <span>report or fight url</span>
            <input id="report-url" placeholder="https://classic.warcraftlogs.com/reports/...">
          </label>
          <label class="field">
            <span>fight number</span>
            <input id="fight-id" placeholder="example: 5">
          </label>
          <label class="field">
            <span>spec</span>
            <select id="spec">
              <option value="warlock-destro">warlock - destruction</option>
              <option value="mage-fire">mage - fire</option>
              <option value="mage-arcane">mage - arcane</option>
              <option value="hunter-bm">hunter - beast mastery</option>
              <option value="rogue-combat">rogue - combat</option>
              <option value="warrior-arms">warrior - arms</option>
              <option value="shaman-enhance">shaman - enhancement</option>
              <option value="shaman-ele">shaman - elemental</option>
              <option value="priest-shadow">priest - shadow</option>
              <option value="druid-feral">druid - feral</option>
            </select>
          </label>
          <label class="field">
            <span>compare to</span>
            <select id="compare-to">
              <option value="p99">99th percentile parse</option>
              <option value="p95">95th percentile parse</option>
              <option value="top-guild">top guild on realm</option>
              <option value="named">named player</option>
            </select>
          </label>
          <label class="field">
            <span>compare player</span>
            <input id="compare-player" placeholder="example: okta-hydraxian-waterlords">
          </label>
          <label class="field">
            <span>compare report url</span>
            <input id="compare-report-url" placeholder="https://classic.warcraftlogs.com/reports/...">
          </label>
          <label class="field">
            <span>notes</span>
            <textarea id="notes" placeholder="optional: fight notes or questions"></textarea>
          </label>
        </div>
        <div class="actions">
          <button class="btn primary" type="submit" id="compare-btn">compare</button>
          <button class="btn" type="button" id="sample-btn">load sample</button>
          <button class="btn" type="reset" id="reset-btn">reset</button>
        </div>
      </form>
    </section>

    <section class="panel" style="animation-delay: 0.1s;">
      <div class="panel-head">
        <h2>comparison</h2>
        <div class="panel-note">gap view for the selected fight</div>
      </div>
      <div class="stat-grid">
        <div class="stat">
          <div class="stat-label">dps delta</div>
          <div class="stat-value" id="stat-dps">--</div>
          <div class="stat-sub" id="stat-dps-sub">you vs top</div>
        </div>
        <div class="stat">
          <div class="stat-label">parse gap</div>
          <div class="stat-value" id="stat-parse">--</div>
          <div class="stat-sub" id="stat-parse-sub">percentile</div>
        </div>
        <div class="stat">
          <div class="stat-label">cooldown usage</div>
          <div class="stat-value" id="stat-cd">--</div>
          <div class="stat-sub" id="stat-cd-sub">uses vs top</div>
        </div>
        <div class="stat">
          <div class="stat-label">uptime diff</div>
          <div class="stat-value" id="stat-uptime">--</div>
          <div class="stat-sub" id="stat-uptime-sub">dot uptime</div>
        </div>
      </div>

      <div class="compare-grid">
        <div>
          <div class="list-title">key gaps</div>
          <ul class="list" id="gap-list">
            <li>
              <div class="list-title">no data yet</div>
              <div class="list-body">run a compare to see gaps and advice</div>
            </li>
          </ul>
        </div>
        <div>
          <div class="list-title">rotation breakdown</div>
          <div class="ability-table" id="ability-table">
            <div class="ability-row">
              <strong>waiting</strong>
              <span>casts</span>
              <span>you</span>
              <span>top</span>
            </div>
          </div>
          <div class="hint" id="rotation-hint">rotation source: wowhead tbc guides</div>
        </div>
      </div>
    </section>

    <section class="panel" style="animation-delay: 0.15s;">
      <div class="panel-head">
        <h2>coach notes</h2>
        <div class="panel-note">actionable steps for next pull</div>
      </div>
      <ul class="list" id="coach-list">
        <li>
          <div class="list-title">ready when you are</div>
          <div class="list-body">once a fight is loaded we will show specific notes here</div>
        </li>
      </ul>
    </section>

    <footer class="footer">
      <span class="badge" id="data-source">data source: demo</span>
      <a href="https://github.com/deanyo" target="_blank" rel="noopener">by dnyo</a>
    </footer>
  </main>

  <script>
    const API_BASE = "https://dnyo-wclogs-proxy.deanryanit.workers.dev";
    const apiStatus = document.getElementById("api-status");
    const apiTag = document.getElementById("api-tag");
    const dataSource = document.getElementById("data-source");
    const form = document.getElementById("compare-form");
    const sampleBtn = document.getElementById("sample-btn");

    const statDps = document.getElementById("stat-dps");
    const statDpsSub = document.getElementById("stat-dps-sub");
    const statParse = document.getElementById("stat-parse");
    const statParseSub = document.getElementById("stat-parse-sub");
    const statCd = document.getElementById("stat-cd");
    const statCdSub = document.getElementById("stat-cd-sub");
    const statUptime = document.getElementById("stat-uptime");
    const statUptimeSub = document.getElementById("stat-uptime-sub");
    const gapList = document.getElementById("gap-list");
    const abilityTable = document.getElementById("ability-table");
    const coachList = document.getElementById("coach-list");
    const rotationHint = document.getElementById("rotation-hint");

    const demoData = {
      summary: {
        you: { name: "dnyo", dps: 1165, parse: 72, cooldowns: 2, uptime: 78 },
        top: { name: "arcflare", dps: 1492, parse: 99, cooldowns: 3, uptime: 92 },
        spec: "warlock - destruction",
        reportId: "TBCDEMO123",
        fightId: 5
      },
      gaps: [
        { title: "cooldown timing", body: "you missed a trinket use in phase 2. line it up with bloodlust for a third use." },
        { title: "dot uptime", body: "immolate uptime is 78% vs 92%. refresh early during movement windows." },
        { title: "cast efficiency", body: "1.6s of idle time between globals, mostly after mechanics. queue the next spell early." }
      ],
      rotation: [
        { spell: "shadow bolt", casts: [54, 68], share: [46, 52] },
        { spell: "immolate", casts: [7, 9], share: [6, 7] },
        { spell: "conflagrate", casts: [6, 7], share: [5, 5] },
        { spell: "curse of doom", casts: [2, 2], share: [2, 2] }
      ],
      coach: [
        "pre-cast shadow bolt 2 seconds before pull to avoid opener delay.",
        "line up first trinket with curse of doom for a stronger opener.",
        "track immolate and refresh at 2 seconds remaining to avoid clipping."
      ],
      wowhead: "https://www.wowhead.com/tbc/guide/classes/warlock/destruction/dps-rotation-cooldowns-abilities"
    };

    function setStatus(text, tone) {
      apiStatus.textContent = text;
      apiTag.classList.remove("status-warn", "status-ok", "status-bad");
      if (tone) apiTag.classList.add(tone);
    }

    function parseReportInput(url, fightInput) {
      if (!url) return { reportId: "", fightId: fightInput || "" };
      const match = url.match(/reports\/([a-zA-Z0-9]+)/);
      const reportId = match ? match[1] : "";
      const fightMatch = url.match(/fight=([0-9]+)/);
      const fightId = fightInput || (fightMatch ? fightMatch[1] : "");
      return { reportId, fightId };
    }

    function clearList(listEl) {
      while (listEl.firstChild) listEl.removeChild(listEl.firstChild);
    }

    function renderGaps(gaps) {
      clearList(gapList);
      if (!gaps.length) {
        const item = document.createElement("li");
        const title = document.createElement("div");
        title.className = "list-title";
        title.textContent = "no clear gaps";
        const body = document.createElement("div");
        body.className = "list-body";
        body.textContent = "pull looks close. compare other bosses or another player.";
        item.append(title, body);
        gapList.appendChild(item);
        return;
      }
      gaps.forEach((gap) => {
        const item = document.createElement("li");
        const title = document.createElement("div");
        title.className = "list-title";
        title.textContent = gap.title;
        const body = document.createElement("div");
        body.className = "list-body";
        body.textContent = gap.body;
        item.append(title, body);
        gapList.appendChild(item);
      });
    }

    function renderRotation(rows, wowheadUrl) {
      clearList(abilityTable);
      const head = document.createElement("div");
      head.className = "ability-row";
      head.innerHTML = "<strong>spell</strong><span>casts</span><span>you</span><span>compare</span>";
      abilityTable.appendChild(head);
      rows.forEach((row) => {
        const line = document.createElement("div");
        line.className = "ability-row";
        const spell = document.createElement("strong");
        spell.textContent = row.spell;
        const cast = document.createElement("span");
        const youCasts = row.casts?.[0] ?? "--";
        const topCasts = row.casts?.[1] ?? "--";
        cast.textContent = youCasts + " vs " + topCasts;
        const you = document.createElement("span");
        const youShare = row.share?.[0];
        you.textContent = Number.isFinite(youShare) ? youShare + "% share" : "n/a";
        const top = document.createElement("span");
        const topShare = row.share?.[1];
        top.textContent = Number.isFinite(topShare) ? topShare + "% share" : "n/a";
        line.append(spell, cast, you, top);
        abilityTable.appendChild(line);
      });
      rotationHint.textContent = wowheadUrl ? "rotation source: wowhead tbc guides" : "rotation source: unknown";
    }

    function renderCoach(lines) {
      clearList(coachList);
      lines.forEach((note) => {
        const item = document.createElement("li");
        const title = document.createElement("div");
        title.className = "list-title";
        title.textContent = "next pull";
        const body = document.createElement("div");
        body.className = "list-body";
        body.textContent = note;
        item.append(title, body);
        coachList.appendChild(item);
      });
    }

    function formatDelta(value, suffix) {
      if (!Number.isFinite(value)) return "--";
      return (value >= 0 ? "+" : "") + value + suffix;
    }

    function formatPair(a, b, suffix) {
      if (!Number.isFinite(a) || !Number.isFinite(b)) return "n/a";
      return a + suffix + " vs " + b + suffix;
    }

    function renderSummary(summary) {
      const dpsDelta = Number.isFinite(summary.top.dps) && Number.isFinite(summary.you.dps)
        ? summary.top.dps - summary.you.dps
        : null;
      statDps.textContent = formatDelta(dpsDelta, " dps");
      statDpsSub.textContent = formatPair(summary.you.dps, summary.top.dps, " dps");
      const parseDelta = Number.isFinite(summary.top.parse) && Number.isFinite(summary.you.parse)
        ? summary.top.parse - summary.you.parse
        : null;
      statParse.textContent = formatDelta(parseDelta, " pts");
      statParseSub.textContent = formatPair(summary.you.parse, summary.top.parse, "");
      statCd.textContent = formatPair(summary.you.cooldowns, summary.top.cooldowns, "");
      statCdSub.textContent = "uses in fight";
      const uptimeDelta = Number.isFinite(summary.top.uptime) && Number.isFinite(summary.you.uptime)
        ? summary.top.uptime - summary.you.uptime
        : null;
      statUptime.textContent = formatDelta(uptimeDelta, "%");
      statUptimeSub.textContent = formatPair(summary.you.uptime, summary.top.uptime, "%");
    }

    function loadDemo() {
      setStatus("demo mode", "status-warn");
      dataSource.textContent = "data source: demo";
      renderSummary(demoData.summary);
      renderGaps(demoData.gaps);
      renderRotation(demoData.rotation, demoData.wowhead);
      renderCoach(demoData.coach);
    }

    async function fetchComparison(payload) {
      if (!API_BASE) return null;
      const response = await fetch(API_BASE.replace(/\/$/, "") + "/compare", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!response.ok) {
        throw new Error("api error");
      }
      return response.json();
    }

    function collectPayload() {
      const region = document.getElementById("region").value;
      const realm = document.getElementById("realm").value.trim();
      const character = document.getElementById("character").value.trim();
      const reportUrl = document.getElementById("report-url").value.trim();
      const fightInput = document.getElementById("fight-id").value.trim();
      const spec = document.getElementById("spec").value;
      const compareTo = document.getElementById("compare-to").value;
      const comparePlayer = document.getElementById("compare-player").value.trim();
      const compareReportUrl = document.getElementById("compare-report-url").value.trim();
      const notes = document.getElementById("notes").value.trim();
      const parsed = parseReportInput(reportUrl, fightInput);
      return {
        region,
        realm,
        character,
        reportUrl,
        reportId: parsed.reportId,
        fightId: parsed.fightId,
        spec,
        compareTo,
        comparePlayer,
        compareReportUrl,
        notes
      };
    }

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const payload = collectPayload();
      if (!payload.realm && !payload.reportId) {
        setStatus("add a realm or report url", "status-bad");
        return;
      }
      if (!payload.comparePlayer && !payload.compareReportUrl) {
        setStatus("add a compare player or compare report url", "status-bad");
        return;
      }
      setStatus("loading comparison", "status-ok");
      dataSource.textContent = "data source: api";
      try {
        const data = await fetchComparison(payload);
        if (!data || data.error) {
          setStatus("api error, showing demo", "status-warn");
          loadDemo();
          return;
        }
        if (data.meta?.demo) {
          setStatus("demo mode: " + (data.meta.reason || "check inputs"), "status-warn");
        } else {
          setStatus("comparison ready", "status-ok");
        }
        renderSummary(data.summary);
        renderGaps(data.gaps || []);
        renderRotation(data.rotation || [], data.wowhead);
        renderCoach(data.coach || []);
      } catch (error) {
        setStatus("api error, showing demo", "status-warn");
        loadDemo();
      }
    });

    sampleBtn.addEventListener("click", () => {
      loadDemo();
    });

    loadDemo();
  </script>
</body>
</html>
